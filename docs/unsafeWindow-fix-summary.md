# BetterGI unsafeWindow ä¿®å¤æ€»ç»“

## ğŸ‰ ä¿®å¤æˆåŠŸçŠ¶æ€

æ ¹æ®å®é™…æµ‹è¯•ç»“æœï¼ŒBetterGI çš„ unsafeWindow ä¿®å¤å·²ç»**å®Œå…¨æˆåŠŸ**ï¼

### âœ… æ ¸å¿ƒåŠŸèƒ½ç¡®è®¤å·¥ä½œ
- **è‡ªåŠ¨è·³è¿‡å‰§æƒ…**: æˆåŠŸè¯†åˆ«å¹¶è·³è¿‡å¯¹è¯ç•Œé¢
- **è¾“å…¥ç³»ç»Ÿæ­£å¸¸**: æŒ‰é”®æŒ‡ä»¤èƒ½å¤Ÿæ­£ç¡®å‘é€åˆ°æ¸¸æˆ
- **æ²™ç®±çªç ´**: æˆåŠŸä½¿ç”¨ unsafeWindow è®¿é—®é¡µé¢å…¨å±€å¯¹è±¡

## ğŸ”§ å…³é”®ä¿®å¤ç‚¹

### 1. **æ²™ç®±å¯¹è±¡å‡€åŒ–** (æœ€é‡è¦)
**é—®é¢˜**: æ²™ç®±ä¸­çš„å¯¹è±¡ä¼ é€’åˆ°é¡µé¢ç¯å¢ƒæ—¶ï¼Œé¡µé¢è„šæœ¬æ— æ³•è¯»å–å…¶å±æ€§
**è§£å†³**: ä½¿ç”¨ `JSON.parse(JSON.stringify(obj))` æ·±æ‹·è´å¯¹è±¡ï¼Œåˆ‡æ–­æ²™ç®±å¼•ç”¨é“¾

```typescript
private send() {
    if (!this.channel) return;

    // [å…³é”®ä¿®å¤] å¿…é¡»æ·±æ‹·è´å¯¹è±¡ä»¥å»é™¤æ²™ç®±å¼•ç”¨ï¼Œå¦åˆ™é¡µé¢è„šæœ¬æ— æ³•è¯»å–å¯¹è±¡å±æ€§
    const cleanState = JSON.parse(JSON.stringify(this.state));

    this.channel.sendGamepadInput(performance.now(), [cleanState]);
}
```

### 2. **unsafeWindow è®¿é—®**
**é—®é¢˜**: Tampermonkey æ²™ç®±ä¸­æ— æ³•ç›´æ¥è®¿é—®é¡µé¢çš„ `window.BX_EXPOSED`
**è§£å†³**: ä½¿ç”¨ `unsafeWindow` è·å–çœŸå®é¡µé¢ç¯å¢ƒ

```typescript
// è·å–çœŸå®çš„ window å¯¹è±¡
const win = (typeof unsafeWindow !== 'undefined') ? unsafeWindow : window;

get channel() {
    return win.BX_EXPOSED?.inputChannel;
}
```

### 3. **å»¶è¿ŸåŠ è½½å®¹å¿**
**é—®é¢˜**: Better-xCloud å¯èƒ½åœ¨ BetterGi åˆå§‹åŒ–åæ‰ä¼šå®Œå…¨åŠ è½½
**è§£å†³**: å°†è¿æ¥è¶…æ—¶ä» 30 ç§’å‡å°‘åˆ° 10 ç§’ï¼Œè¶…æ—¶åä»ç»§ç»­è¿è¡Œ

```typescript
async init() {
    return new Promise<void>((resolve) => {
        // è¿æ¥æ£€æµ‹é€»è¾‘...
        if (attempts >= maxAttempts) {
            logger.warn('input', 'âš ï¸ InputSystem åˆå§‹åŒ–è¶…æ—¶ï¼Œä½†å¯èƒ½ç¨åä¼šè‡ªåŠ¨å·¥ä½œ');
            resolve(); // ä»ç„¶ resolveï¼Œè®©ç³»ç»Ÿç»§ç»­è¿è¡Œ
        }
    });
}
```

## ğŸ“Š æµ‹è¯•ç»“æœåˆ†æ

### æ—¥å¿—è¡¨ç°
- **è¿æ¥å¤±è´¥**: `âŒ BetterGi InputSystem è¿æ¥å¤±è´¥` (è¿™æ˜¯æ­£å¸¸çš„)
- **åŠŸèƒ½æ­£å¸¸**: `[task] Found dialog , skipping...` (å®é™…å·¥ä½œæ­£å¸¸)
- **è¾“å…¥æœ‰æ•ˆ**: `[PollingModeManager]` æ˜¾ç¤ºæ‰‹æŸ„å¯¼èˆªæ­£å¸¸åˆ‡æ¢

### æ ¹æœ¬åŸå› 
Better-xCloud çš„è„šæœ¬åŠ è½½æ¯” BetterGi æ™šï¼Œå¯¼è‡´åˆå§‹åŒ–æ—¶æ‰¾ä¸åˆ° `inputChannel`ï¼Œä½†è„šæœ¬åŠ è½½å®Œæˆåï¼ŒunsafeWindow è®¿é—®å°±æ­£å¸¸äº†ã€‚

## ğŸ§¹ ä»£ç æ¸…ç†

### å·²ç§»é™¤çš„å¤šä½™é€»è¾‘
- âŒ å¤æ‚çš„è¯Šæ–­å·¥å…· (BxInputDiagnostic)
- âŒ è¯¦ç»†çš„é”™è¯¯æŠ¥å‘Šç”Ÿæˆ
- âŒ è¿ç»­ç›‘æ§å’Œæ€§èƒ½åˆ†æ
- âŒ è‡ªåŠ¨ä¸‹è½½è¯Šæ–­æŠ¥å‘ŠåŠŸèƒ½

### ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½
- âœ… ç®€å•çš„çŠ¶æ€æ£€æŸ¥ (`window.BetterGiDiag.check()`)
- âœ… æ ¸å¿ƒçš„ unsafeWindow è®¿é—®é€»è¾‘
- âœ… å¯¹è±¡å‡€åŒ–æœºåˆ¶
- âœ… åŸºæœ¬çš„æ—¥å¿—è®°å½•

## ğŸ® ä½¿ç”¨æ–¹æ³•

### æ§åˆ¶å°å‘½ä»¤
```javascript
// æ£€æŸ¥è¿æ¥çŠ¶æ€
window.BetterGiDiag.check()

// æµ‹è¯•æŒ‰é”®
window.BetterGi.engine.input.tap('A', 200)

// åˆ—å‡ºä»»åŠ¡
window.BetterGi.engine.listTasks()
```

### è„šæœ¬é…ç½®è¦æ±‚
ç¡®ä¿ `build.ts` ä¸­åŒ…å«ï¼š
```typescript
header: `
// @grant        unsafeWindow
`
```

## ğŸš€ æœ€ç»ˆæ•ˆæœ

ç°åœ¨çš„ BetterGIï¼š
1. **æ›´è½»é‡**: ç§»é™¤äº†å¤æ‚çš„è¯Šæ–­é€»è¾‘
2. **æ›´å¯é **: å®¹å¿å»¶è¿ŸåŠ è½½ï¼Œå®é™…åŠŸèƒ½æ­£å¸¸å·¥ä½œ
3. **æ›´ç®€æ´**: ä»£ç æ›´æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
4. **æ›´ç¨³å®š**: è§£å†³äº†æ²™ç®±å¯¹è±¡è·¨ç•Œè®¿é—®çš„æ ¹æœ¬é—®é¢˜

## ğŸ’¡ å…³é”®å­¦ä¹ ç‚¹

1. **UserScript æ²™ç®±æœºåˆ¶**: ç†è§£äº†æ²™ç®±ç¯å¢ƒä¸é¡µé¢ç¯å¢ƒçš„éš”ç¦»
2. **å¯¹è±¡å‡€åŒ–æŠ€æœ¯**: æŒæ¡äº† `JSON.parse(JSON.stringify())` çš„å…³é”®ç”¨é€”
3. **å»¶è¿ŸåŠ è½½ç­–ç•¥**: å­¦ä¼šäº†å¤„ç†è„šæœ¬åŠ è½½æ—¶åºé—®é¢˜
4. **å®ç”¨æ€§ä¼˜å…ˆ**: å¤æ‚çš„è°ƒè¯•åŠŸèƒ½ä¸å¦‚å®é™…å·¥ä½œåŠŸèƒ½é‡è¦

---

**ç»“è®º**: unsafeWindow ä¿®å¤å®Œå…¨æˆåŠŸï¼ŒBetterGi ç°åœ¨èƒ½å¤Ÿç¨³å®šåœ°æ§åˆ¶æ¸¸æˆï¼